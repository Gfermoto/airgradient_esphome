# Установка

## Установка ESPHome

1. Установите ESPHome через Home Assistant:
   - Перейдите в раздел "Надстройки" (Add-ons)
   - Найдите ESPHome
   - Нажмите "Установить" (Install)
   - После установки нажмите "Запустить" (Start)

2. Клонируйте этот репозиторий в директорию установки Home Assistant:
   ```bash
   cd /config
   git clone https://github.com/airgradienthq/airgradient_esphome.git
   ```

3. Создайте файл `secrets.yaml` в директории ESPHome:
   ```yaml
   # Секреты для AirGradient
   airgradient_api_key: "your_api_key_here"
   airgradient_sensor_id: "your_sensor_id_here"
   wifi_ssid: "your_wifi_ssid"
   wifi_password: "your_wifi_password"
   ```

4. Загрузите прошивку на ваше устройство:
   - Откройте ESPHome в Home Assistant
   - Нажмите "+" для добавления нового устройства
   - Выберите "Импортировать существующую конфигурацию"
   - Выберите соответствующий файл конфигурации из директории `airgradient_esphome`
   - Нажмите "Установить" и следуйте инструкциям

## Обновление прошивки

1. Получите последние изменения из репозитория:
   ```bash
   cd /config/airgradient_esphome
   git pull
   ```

2. В ESPHome:
   - Выберите ваше устройство
   - Нажмите "Обновить"
   - Следуйте инструкциям на экране

## Устранение неполадок

Если у вас возникли проблемы с установкой:

1. Проверьте подключение к Wi-Fi:
   - Убедитесь, что SSID и пароль указаны правильно
   - Проверьте, что устройство находится в зоне действия сети

2. Проверьте API ключ:
   - Убедитесь, что API ключ указан правильно
   - Проверьте, что сенсор ID соответствует вашему устройству

3. Проверьте подключение датчиков:
   - Убедитесь, что все датчики правильно подключены
   - Проверьте питание устройства

4. Если проблема не решена:
   - Проверьте логи ESPHome
   - Обратитесь в поддержку AirGradient

## Стандартная установка

* В веб-интерфейсе ESPHome нажмите "Новое устройство". Дайте любое имя. Выберите любую модель платы и нажмите "Пропустить" на последней странице, чтобы не устанавливать сейчас. Нажмите "Редактировать" на новой записи и замените содержимое файлом .yaml для вашей модели.
* Или скопируйте файл .yaml из основной папки для вашей модели в этом репозитории и поместите его в папку `config` вашего ESPHome.
* Внесите желаемые изменения в подстановки, чтобы назвать устройства для вашего случая использования
* Установите на устройство, используя один из вариантов ESPHome.

> Примечание: по умолчанию ESPHome синхронизирует удаленные репозитории, на которые ссылаются пакеты, только один раз в день, поэтому если в репозитории внесены изменения, вы можете не получить обновленную конфигурацию до 1 дня после публикации. Вы можете удалить содержимое папки config/.esphome/packages, чтобы принудительно обновить раньше

> Примечание: установка `add_mac_suffix: "true"` позволяет иметь несколько устройств в вашей сети одновременно и отображать их как уникальные записи, даже если ваше поле `name:` дублируется, но это может привести к тому, что ESPHome не будет определять устройства как "В сети" после установки, поскольку ESPHome ищет только поле `name:`, а фактическое имя устройства имеет MAC-адрес, добавленный в конец

> Один из способов решить эту проблему - изменить `add_mac_suffix: "false"`, чтобы имя устройства точно совпадало. Если у вас несколько устройств, убедитесь, что поле `name:` уникально для каждого устройства

> Другой вариант - добавить статический IP в конфигурацию wifi и настроить ESPHome для пинга устройства по IP вместо имени хоста

> [Dashboard status light not working across subnets/zones · Issue #641 · esphome/issues (github.com)](https://github.com/esphome/issues/issues/641#issuecomment-534156628)

Пример для статического IP

```yaml
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  manual_ip:
    static_ip: 192.168.1.121
    gateway: 192.168.1.1
    subnet: 255.255.255.0
    dns1: 192.168.1.1
```

## Установка через веб-интерфейс ESPHome

Установите скомпилированный файл на ваше устройство с помощью только браузера и USB-кабеля, установка ESPHome не требуется.

Сохраните соответствующий файл .bin и перейдите по адресу [https://web.esphome.io/](https://web.esphome.io/) в вашем браузере, чтобы подключить ваше устройство ESP и отправить файл .bin на него

В некоторых случаях устройство может столкнуться с ошибками при использовании веб-инструмента прошивки. Шаги для перевода устройства в специальный режим загрузки прошивки можно найти здесь:
[https://forum.airgradient.com/t/airgradient-one-not-working-after-flashing-with-arduino/1326/4 ](https://forum.airgradient.com/t/airgradient-one-not-working-after-flashing-with-arduino/1326/4)

## Полный YAML файл

Папка `full_config` содержит один yaml файл для каждой модели, который содержит полную автономную конфигурацию, созданную командой `esphome config`. Это добавляет все дополнительные параметры, поэтому файл намного длиннее минимальной конфигурации, но один файл содержит всю необходимую информацию для полной независимости от этого репозитория.

Скопируйте полный конфигурационный файл в ваш личный файл конфигурации ESPhome и настройте по желанию, затем установите на ваше устройство.

## Устранение неполадок

Если некоторые датчики не показывают правильные показания после установки или обновления, пожалуйста, полностью отключите кабель питания от устройства на 5-10 секунд, затем снова подключите. Многие проблемы решаются полным сбросом питания, так как программный сброс не полностью очищает некоторые ситуации.
