# AirGradient Pro V3.3 - V4.2
# https://www.airgradient.com/open-airgradient/instructions/overview/

substitutions:
  name: "ag-pro"
  friendly_name: "AG Pro"
  name_add_mac_suffix: "false"  # Must have quotes around value

# Enable Home Assistant API with encryption and rate limiting
api:
  encryption:
    key: !secret api_encryption_key
  reboot_timeout: 15min
  services:
    - service: restart
      then:
        - delay: 5s
        - restart: soft

# Over-the-Air updates with password protection
ota:
  platform: esphome
  password: !secret ota_password
  safe_mode: true
  num_attempts: 10

# WiFi configuration with automatic reconnection and fallback AP
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none
  fast_connect: true
  reboot_timeout: 15min
  
  # Fallback AP configuration
  ap:
    ssid: "${friendly_name} Fallback Hotspot"
    password: !secret wifi_ap_password

# Enable logging with rotation
logger:
  level: INFO
  baud_rate: 0
  logs:
    max_message_length: 150
    queue_size: 25

# Web server disabled to save resources on ESP8266
# web_server:
#   port: 80
#   auth:
#     username: !secret web_username
#     password: !secret web_password

dashboard_import:
  package_import_url: github://MallocArray/airgradient_esphome/airgradient-pro.yaml
  import_full_config: false

# System monitoring
sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s
    id: wifi_signal
  - platform: free_heap
    name: "${friendly_name} Free Heap"
    update_interval: 60s
    id: free_heap

packages:
  board: github://MallocArray/airgradient_esphome/packages/airgradient_d1_mini_board.yaml
  captive_portal: github://MallocArray/airgradient_esphome/packages/captive_portal.yaml
  pm_2.5: github://MallocArray/airgradient_esphome/packages/sensor_pms5003.yaml
  co2: github://MallocArray/airgradient_esphome/packages/sensor_s8.yaml
  temp_humidity: github://MallocArray/airgradient_esphome/packages/sensor_sht40.yaml
  # temp_humidity: github://MallocArray/airgradient_esphome/packages/sensor_sht30.yaml
  tvoc: github://MallocArray/airgradient_esphome/packages/sensor_sgp41.yaml
  display: github://MallocArray/airgradient_esphome/packages/display_sh1106_single_page.yaml
  airgradient_api: github://MallocArray/airgradient_esphome/packages/airgradient_api_d1_mini.yaml
  config_button: github://MallocArray/airgradient_esphome/packages/config_button.yaml
  wifi: github://MallocArray/airgradient_esphome/packages/sensor_wifi.yaml
  uptime: github://MallocArray/airgradient_esphome/packages/sensor_uptime.yaml

binary_sensor:
  - platform: gpio
    id: config_button
    pin:
      number: D7
      mode: INPUT_PULLUP
    name: "${friendly_name} Config Button"
    on_press:
      then:
        - logger.log: "Config button pressed"
        - homeassistant.service:
            service: homeassistant.restart

# Automation for system protection
automation:
  - trigger:
      platform: free_heap
      below: 4096  # 4KB free heap
    then:
      - logger.log: "Low memory detected, restarting"
      - delay: 5s
      - restart: soft
